@using Microsoft.AspNetCore.Mvc
@using System.Drawing
@inject GameState State

@* <HeadContent>
    <style>
        :root {
            --board-bg: @ColorTranslator.ToHtml(BoardColor);  /** the color of the board **/
           /** --player1: @State.Player1Color;      /** Player 1's piece color **/
           /** --player2: @State.Player2Color;     /** Player 2's piece color **/
        }
    </style>
</HeadContent> *@

<div style="--player1: @State.Player1Color; --player2: @State.Player2Color; --board-bg: @ColorTranslator.ToHtml(BoardColor);">

    <div class="color-selectors ">
        <p>Choose any color you would like to play with</p>
        <div>
            <label>Player 1:</label>
            <input type="color" @bind="State.Player1Color" @bind:event="oninput" />
            
            <label class="ms-3">Player 2:</label>
            <input type="color" @bind="State.Player2Color" @bind:event="oninput" />
        </div>
    </div>

    <div class="score-board mt-3 mb-3 border border-2 p-2">
        <h4>Score Board</h4>
        <div class="p1-stats" style="color: var(--player1)">
            Player 1 Score: <strong>@State.Player1Score</strong>
        </div>
        <div class="p2-stats" style="color: var(--player2)">
            Player 2 Score: <strong>@State.Player2Score</strong>
        </div>
    </div>

    <article class="text-center">
        @winnerMessage  <button style="@ResetStyle" @onclick="ResetGame">Reset the game?</button>
        <br />
        <span class="alert-danger">@errorMesage</span>
        <span class="alert-info">@CurrentTurn</span>
    </article>

    <nav class="mt-3 d-flex justify-align-center selector">
        @for (byte i = 0; i < 7; i++)
        {
            var col = i;
            <span title="Click to play a piece" @onclick="() => PlayPiece(col)">ðŸ”½</span>
        }
    </nav>

    <div class="mb-5 text-center">
        <div class="board">
            @for (var i = 0; i < 42; i++)
            {
                <span class="container">
                    <span></span>
                </span>
            }
            @for (var i = 0; i < 42; i++)
            {
                <span class="@pieces[i]"></span>
            }
        </div>
    </div>
</div>

@code{

    private string[] pieces = new string[42];
    private string winnerMessage = string.Empty;
    private string errorMesage = string.Empty;

    private string CurrentTurn => (winnerMessage == string.Empty) ? $"Player {State.PlayerTurn}'s Turn" : "";
    private string ResetStyle => (winnerMessage == string.Empty) ? "display: none;" : "";

    private void PlayPiece(byte col)
    {
        if (!string.IsNullOrEmpty(winnerMessage))
        {
            return; // Exit the method so no pieces are placed and no scores are added
        }

        errorMesage = string.Empty;
        try
        {
            var player = State.PlayerTurn;
            var turn = State.CurrentTurn;
            var landingRow = State.PlayPiece(col);
            pieces[turn] = $"player{player} col{col} drop{landingRow}";
        }
        catch (ArgumentException ex)
        {
            errorMesage =ex.Message;
        }

        winnerMessage = State.CheckForWin() switch
        {
            GameState.WinState.Player1_Wins => IncrementScore(1),
            GameState.WinState.Player2_Wins => IncrementScore(2),
            GameState.WinState.Tie => "It's a tie!", 
            _ => ""
        };
    }

    private string IncrementScore(int winner)
    {
        if (winner == 1)
        {
            State.Player1Score++;
            return "Player 1 Wins!";
        }
        else
        {
            State.Player2Score++;
            return "Player 2 Wins!";
        }
    }

    void ResetGame() 
    {
        State.ResetBoard();
        winnerMessage = string.Empty;
        errorMesage = string.Empty;
        pieces = new string[42];
    }


    [Parameter]
    public Color BoardColor {get; set;} = ColorTranslator.FromHtml("black");
    [Parameter]
    public Color Player1Color {get; set;} = ColorTranslator.FromHtml("#7f1313");
    [Parameter]
    public Color Player2Color {get; set;} =ColorTranslator.FromHtml("#15205e");

    protected override void OnInitialized()
    {
        State.ResetBoard();
    }

}